#! /usr/bin/env python3
# -*- coding:utf-8 -*-
# Copyright 2018-  <linrongbin16@gmail.com>

import sys
import os
import getopt
import time
sys.path.append('.')
import util

help_msg = '''Generate auto complete database.

usage:
    genv -c/--c         generate compile_commands.json based on CMakeLists.txt for C/C++.

flag:
    genv -h/--help      show help message.
'''


def _help():
    print(help_msg)
    exit(0)


def _cpp():
    print('[vcmd] generate compile_commands.json for c/c++')
    gen_folder = '.genv.%s' % (str(time.time()))
    os.system('cmake -B %s -DCMAKE_EXPORT_COMPILE_COMMANDS=ON .' % (gen_folder))
    if not os.path.exists('%s/compile_commands.json' % (gen_folder)):
        raise Exception('%s/compile_commands.json not exist' % (gen_folder))
    os.system('cp %s/compile_commands.json .' % (gen_folder))
    os.system('rm -rf %s' % (gen_folder))
    print('[vcmd] generate compile_commands.json for c/c++ - done')
    exit(0)

if __name__ == '__main__':
    try:
        opts, args = getopt.getopt(sys.argv[1:], 'cph', [
            'c', 'python', 'help'
        ])
        for opt in opts:
            if opt[0] in ('-c', '--c'):
                _cpp()
        _help()
    except getopt.GetoptError as e:
        print(str(e) + '\n')
        _help()
    except Exception as e:
        print(str(e) + '\n')
